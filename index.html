<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #1c1c1e);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #9e9e9e);
            --button-color: var(--tg-theme-button-color, #2ea6ff);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            padding-bottom: 80px;
        }

        h2, h3 { margin-top: 0; }
        .section {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        label { display: block; color: var(--hint-color); font-size: 13px; margin-bottom: 4px; }
        input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--hint-color);
            color: var(--text-color);
            font-size: 16px;
            padding: 8px 0;
            margin-bottom: 12px;
            outline: none;
            box-sizing: border-box;
        }
        input:focus { border-bottom-color: var(--button-color); }

        .row-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .row-inputs input { margin-bottom: 0; }
        .day-input { width: 50px; text-align: center; }
        
        .btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--button-color);
            color: var(--button-color);
            margin-top: 8px;
        }
        .btn-remove {
            background: #ff3b30; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;
        }

        #result { display: none; margin-top: 20px; }
        .result-card {
            background: #232323; padding: 15px; border-radius: 10px; border-left: 5px solid var(--button-color);
        }
        .big-number { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .warning { border-left-color: #ffcc00; color: #ffcc00; }
        .danger { border-left-color: #ff3b30; color: #ff3b30; }

        /* Floating Main Button handled by TG WebApp, but we add a visual one too */
    </style>
</head>
<body>

    <div id="app">
        <div class="section">
            <h3>üìÖ –û—Å–Ω–æ–≤–Ω–æ–µ</h3>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞</label>
            <input type="text" id="monthName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—é–Ω—å" value="–¢–µ–∫—É—â–∏–π">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>–í—Å–µ–≥–æ –¥–Ω–µ–π</label>
                    <input type="number" id="daysTotal" value="30">
                </div>
                <div style="flex: 1;">
                    <label>–°–µ–≥–æ–¥–Ω—è (—á–∏—Å–ª–æ)</label>
                    <input type="number" id="currentDay" value="1">
                </div>
            </div>

            <label>üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–≤—Å–µ –¥–µ–Ω—å–≥–∏)</label>
            <input type="text" id="balance" placeholder="15 000 –∏–ª–∏ 15–∫">
        </div>

        <div class="section">
            <h3>üí∏ –î–æ—Ö–æ–¥—ã –∏ –†–∞—Å—Ö–æ–¥—ã (–±—É–¥—É—â–∏–µ)</h3>
            <p style="font-size: 12px; color: var(--hint-color)">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞.</p>
            
            <div id="items-container"></div>
            
            <button class="btn btn-outline" onclick="addItem()">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>

        <div class="section">
            <h3>üéØ –¶–µ–ª–∏ –∏ –õ–∏–º–∏—Ç—ã</h3>
            <label>–û—Ç–ª–æ–∂–∏—Ç—å –≤ –∫–æ–ø–∏–ª–∫—É</label>
            <input type="text" id="savings" placeholder="0">

            <label>–ú–∏–Ω–∏–º—É–º –Ω–∞ –µ–¥—É/–ø—Ä–æ–µ–∑–¥ (–≤ –¥–µ–Ω—å)</label>
            <input type="text" id="ironDaily" placeholder="500">
        </div>

        <button class="btn" onclick="calculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –ë–Æ–î–ñ–ï–¢</button>

        <div id="result" class="section">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <div id="resultContent" class="result-card"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –õ–û–ì–ò–ö–ê ---

        function parseValue(str) {
            if (!str) return 0.0;
            str = str.toString().toLowerCase().replace(/\s/g, '');
            let mult = 1;
            if (str.includes('k') || str.includes('–∫')) {
                mult = 1000;
                str = str.replace(/[k–∫]/g, '');
            }
            str = str.replace(',', '.');
            const val = parseFloat(str);
            return isNaN(val) ? 0.0 : val * mult;
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(num);
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º
        function addItem() {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'row-inputs';
            div.innerHTML = `
                <input type="number" class="day-input" placeholder="–î–Ω">
                <input type="text" class="amount-input" placeholder="–°—É–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: -5–∫ –∏–ª–∏ 10–∫)">
                <button class="btn btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }
        // –î–æ–±–∞–≤–∏–º –ø–∞—Ä—É –ø–æ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        addItem(); addItem();

        function getItems() {
            const items = [];
            document.querySelectorAll('.row-inputs').forEach(row => {
                const d = parseInt(row.querySelector('.day-input').value);
                const amtStr = row.querySelector('.amount-input').value;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞–∫ (—Ä–∞—Å—Ö–æ–¥ –∏–ª–∏ –¥–æ—Ö–æ–¥)
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–≤–µ–ª –º–∏–Ω—É—Å, –Ω–æ —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥, –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–µ–µ. 
                // –£–ø—Ä–æ—Å—Ç–∏–º: –ø—É—Å—Ç—å –≤–≤–æ–¥–∏—Ç —Å –º–∏–Ω—É—Å–æ–º –¥–ª—è —Ä–∞—Å—Ö–æ–¥–∞, —Å –ø–ª—é—Å–æ–º –¥–ª—è –¥–æ—Ö–æ–¥–∞.
                // –õ–∏–±–æ —Å–¥–µ–ª–∞–µ–º —Å–µ–ª–µ–∫—Ç. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å–µ–π—á–∞—Å: "–í—Å–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ —Å—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥–∞–º–∏, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø".
                // –í –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –±—ã–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –°–¥–µ–ª–∞–µ–º –∑–¥–µ—Å—å –ø—Ä–æ—â–µ: 
                // –ü—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫. –ï—Å–ª–∏ —Å—É–º–º–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è (–≤–≤–µ–ª -5000) - —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥. 
                // –ù–æ –ª—É—á—à–µ –¥–æ–±–∞–≤–∏–º Select, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å.
                
                // –ü–ï–†–ï–î–ï–õ–´–í–ê–ï–ú addItem –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞:
            });
            return items;
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–º addItem –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (–î–æ—Ö–æ–¥/–†–∞—Å—Ö–æ–¥)
        document.getElementById('items-container').innerHTML = ''; // Clear
        function addItemImproved(type = 'expense') {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'row-inputs';
            const isInc = type === 'income';
            div.innerHTML = `
                <select class="type-select" style="width: 40px; border:none; background:transparent; color:white;">
                    <option value="exp" ${!isInc?'selected':''}>üìâ</option>
                    <option value="inc" ${isInc?'selected':''}>üìà</option>
                </select>
                <input type="number" class="day-input" placeholder="–ß–∏—Å–ª–æ">
                <input type="text" class="amount-input" placeholder="–°—É–º–º–∞ (10–∫)">
                <button class="btn btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }
        // –ó–∞–º–µ–Ω–∏–º –∫–Ω–æ–ø–∫—É –Ω–∞ –¥–≤–µ
        const btnContainer = document.querySelector('.btn-outline').parentElement;
        btnContainer.innerHTML = `
            <div id="items-container"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-outline" onclick="addItemImproved('expense')" style="flex:1; border-color:#ff3b30; color:#ff3b30">Add –†–∞—Å—Ö–æ–¥</button>
                <button class="btn btn-outline" onclick="addItemImproved('income')" style="flex:1; border-color:#34c759; color:#34c759">Add –î–æ—Ö–æ–¥</button>
            </div>
        `;
        // –ò–Ω–∏—Ç
        addItemImproved('expense');

        // –Ø–¥—Ä–æ —Ä–∞—Å—á–µ—Ç–∞ (–°–∏–º—É–ª—è—Ü–∏—è)
        function simulateCashflow(testDailyLimit, data) {
            let balance = data.balance;
            const startD = data.currentDay;
            const endD = data.daysTotal;
            const timeline = {};

            // –ó–∞–ø–æ–ª–Ω—è–µ–º timeline
            data.items.forEach(item => {
                if (item.day >= startD) {
                    if (!timeline[item.day]) timeline[item.day] = { inc: 0, exp: 0 };
                    if (item.type === 'inc') timeline[item.day].inc += item.amount;
                    else timeline[item.day].exp += item.amount;
                }
            });

            // –ö–æ–ø–∏–ª–∫–∞ (—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å)
            if (!timeline[endD]) timeline[endD] = { inc: 0, exp: 0 };
            timeline[endD].exp += data.savings;

            let currentSimBalance = balance;

            for (let day = startD; day <= endD; day++) {
                const ops = timeline[day] || { inc: 0, exp: 0 };
                currentSimBalance += ops.inc;
                currentSimBalance -= ops.exp;
                
                // –í—ã—á–∏—Ç–∞–µ–º –ª–∏–º–∏—Ç (–∂–µ–ª–µ–∑–Ω—ã–π + —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–π)
                currentSimBalance -= (data.ironDaily + testDailyLimit);

                if (currentSimBalance < -50) return false; // –ö–∞—Å—Å–æ–≤—ã–π —Ä–∞–∑—Ä—ã–≤
            }
            return true;
        }

        function calculate() {
            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
            const currentDay = parseInt(document.getElementById('currentDay').value) || 1;
            const daysTotal = parseInt(document.getElementById('daysTotal').value) || 30;
            const balance = parseValue(document.getElementById('balance').value);
            const savings = parseValue(document.getElementById('savings').value);
            const ironDaily = parseValue(document.getElementById('ironDaily').value);
            
            const items = [];
            document.querySelectorAll('.row-inputs').forEach(row => {
                const type = row.querySelector('.type-select').value;
                const day = parseInt(row.querySelector('.day-input').value);
                const amount = parseValue(row.querySelector('.amount-input').value);
                if (day && amount) items.push({ type, day, amount });
            });

            const data = { balance, currentDay, daysTotal, items, savings, ironDaily };
            const daysLeft = daysTotal - currentDay + 1;

            // –†–∞—Å—á–µ—Ç (–ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫)
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –ø—É–ª
            let futureInc = items.filter(i => i.type === 'inc' && i.day >= currentDay).reduce((a,b)=>a+b.amount,0);
            let futureExp = items.filter(i => i.type === 'exp' && i.day >= currentDay).reduce((a,b)=>a+b.amount,0);
            
            let totalResources = balance + futureInc;
            let totalObligations = futureExp + savings;
            let totalIronNeeded = ironDaily * daysLeft;
            
            let freePool = totalResources - totalObligations - totalIronNeeded;
            
            let safeLimit = 0;
            let cashGap = false;

            if (freePool > 0) {
                let theoretical = freePool / daysLeft;
                let low = 0, high = theoretical * 1.5;
                
                for(let i=0; i<20; i++) {
                    let mid = (low + high) / 2;
                    if (simulateCashflow(mid, data)) {
                        safeLimit = mid;
                        low = mid;
                    } else {
                        high = mid;
                    }
                }
                
                if (safeLimit < (theoretical * 0.95)) cashGap = true;
            } else {
                safeLimit = -1;
            }

            // –í—ã–≤–æ–¥
            const resDiv = document.getElementById('result');
            const content = document.getElementById('resultContent');
            resDiv.style.display = 'block';
            
            let html = `<div>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: <b>${daysLeft}</b></div>`;
            
            if (safeLimit < 0) {
                content.className = 'result-card danger';
                html += `<div class="big-number">–î–ï–§–ò–¶–ò–¢: ${formatCurrency(Math.abs(freePool))}</div>`;
                html += `<div>–í–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –¥–µ–Ω—å–≥–∏ –∏–ª–∏ —É—Ä–µ–∑–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã!</div>`;
            } else {
                content.className = cashGap ? 'result-card warning' : 'result-card';
                html += `<div>–¢—Ä–∞—Ç–∏—Ç—å –≤ –¥–µ–Ω—å (–Ω–∞ —Ö–æ—Ç–µ–ª–∫–∏):</div>`;
                html += `<div class="big-number" style="color: #34c759">${formatCurrency(safeLimit)}</div>`;
                html += `<div>+ ${formatCurrency(ironDaily)} (–Ω–∞ –µ–¥—É)</div>`;
                html += `<hr style="border-color:#555">`;
                html += `<div>–ò–¢–û–ì–û –í –î–ï–ù–¨: <b>${formatCurrency(safeLimit + ironDaily)}</b></div>`;
                
                if (cashGap) {
                    html += `<br><small>‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b> –õ–∏–º–∏—Ç –∑–∞–Ω–∏–∂–µ–Ω –∏–∑-–∑–∞ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞ (–∫—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã —Ä–∞–Ω—å—à–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π).</small>`;
                }
            }

            content.innerHTML = html;
            
            // –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–µ"
            tg.MainButton.text = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é";
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                const reportData = {
                    month: document.getElementById('monthName').value,
                    total_inc: totalResources,
                    total_exp: totalObligations,
                    safe_limit: safeLimit
                };
                tg.sendData(JSON.stringify(reportData));
            });
        }

    </script>
</body>
</html>
