<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro Calc</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #efeff4);
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; box-sizing: border-box; }
        .step { display: none; }
        .step.active { display: block; }
        h2 { margin-top: 0; color: var(--btn); }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 14px; color: var(--hint); margin-bottom: 8px; }
        input, select { 
            width: 100%; padding: 12px; border: 1px solid var(--sec-bg); 
            background: var(--sec-bg); color: var(--text); border-radius: 8px; 
            box-sizing: border-box; font-size: 16px; outline: none;
        }
        .item-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .item-row input:first-child { width: 60px; }
        .btn-add { background: none; border: 1px dashed var(--btn); color: var(--btn); width: 100%; padding: 8px; border-radius: 8px; cursor: pointer; }
        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-next { background: var(--btn); color: var(--btn-text); border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; }
        .btn-back { background: var(--hint); color: #fff; border: none; padding: 15px; width: 80px; border-radius: 10px; }
        .summary-card { background: var(--sec-bg); padding: 15px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="wizard">
    <!-- –®–∞–≥ 1: –ë–∞–∑–∞ -->
    <div class="step active" id="step1">
        <h2>üìÖ –ü–µ—Ä–∏–æ–¥</h2>
        <div class="input-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞</label>
            <input type="text" id="monthName" value="–Ø–Ω–≤–∞—Ä—å">
        </div>
        <div style="display: flex; gap: 10px;">
            <div class="input-group">
                <label>–î–Ω–µ–π –≤ –º–µ—Å.</label>
                <input type="number" id="daysTotal" value="31">
            </div>
            <div class="input-group">
                <label>–°–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ</label>
                <input type="number" id="currentDay" value="1">
            </div>
        </div>
        <button class="btn-next" onclick="nextStep(2)">–î–∞–ª–µ–µ</button>
    </div>

    <!-- –®–∞–≥ 2: –î–µ–Ω—å–≥–∏ -->
    <div class="step" id="step2">
        <h2>üí∞ –ë–∞–ª–∞–Ω—Å –∏ –î–æ—Ö–æ–¥—ã</h2>
        <div class="input-group">
            <label>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–Ω–∞ —Ä—É–∫–∞—Ö)</label>
            <input type="text" id="balance" placeholder="50000">
        </div>
        <label>–ë—É–¥—É—â–∏–µ –¥–æ—Ö–æ–¥—ã (–ß–∏—Å–ª–æ | –°—É–º–º–∞)</label>
        <div id="incomes-list"></div>
        <button class="btn-add" onclick="addRow('incomes-list')">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
        <div class="nav-btns">
            <button class="btn-back" onclick="nextStep(1)">‚Üê</button>
            <button class="btn-next" onclick="nextStep(3)">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <!-- –®–∞–≥ 3: –†–∞—Å—Ö–æ–¥—ã -->
    <div class="step" id="step3">
        <h2>üìâ –û–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</h2>
        <label>–ö—Ä–µ–¥–∏—Ç—ã –∏ –¥–æ–ª–≥–∏ (–ß–∏—Å–ª–æ | –°—É–º–º–∞)</label>
        <div id="loans-list"></div>
        <button class="btn-add" onclick="addRow('loans-list')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        
        <label style="margin-top:10px">–ñ–ö–• –∏ –°–≤—è–∑—å</label>
        <div id="utils-list"></div>
        <button class="btn-add" onclick="addRow('utils-list')">+ –î–æ–±–∞–≤–∏—Ç—å</button>

        <label style="margin-top:10px">–ü–æ–∫—É–ø–∫–∏ / –í—Ä–∞—á–∏ / –¢–û</label>
        <div id="shop-list"></div>
        <button class="btn-add" onclick="addRow('shop-list')">+ –î–æ–±–∞–≤–∏—Ç—å</button>

        <div class="nav-btns">
            <button class="btn-back" onclick="nextStep(2)">‚Üê</button>
            <button class="btn-next" onclick="nextStep(4)">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <!-- –®–∞–≥ 4: –ò—Ç–æ–≥–∏ -->
    <div class="step" id="step4">
        <h2>üê∑ –†–µ–∑–µ—Ä–≤—ã</h2>
        <div class="input-group">
            <label>–û—Ç–ª–æ–∂–∏—Ç—å –≤ –∫–æ–ø–∏–ª–∫—É (—Å—É–º–º–∞)</label>
            <input type="text" id="savings" value="0">
        </div>
        <div class="input-group">
            <label>–ú–∏–Ω–∏–º—É–º –Ω–∞ –µ–¥—É –≤ –¥–µ–Ω—å</label>
            <input type="text" id="ironDaily" value="500">
        </div>
        <div class="nav-btns">
            <button class="btn-back" onclick="nextStep(3)">‚Üê</button>
            <button class="btn-next" onclick="finish()">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –ë–Æ–î–ñ–ï–¢</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    function nextStep(s) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
    }

    function addRow(containerId) {
        const cont = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="number" placeholder="–î–∞—Ç–∞" class="d"> <input type="text" placeholder="–°—É–º–º–∞" class="v">`;
        cont.appendChild(div);
    }

    function parseVal(val) {
        if(!val) return 0;
        let s = val.toString().toLowerCase().replace(/\s/g, '').replace(',', '.');
        let m = 1;
        if(s.includes('k') || s.includes('–∫')) { m = 1000; s = s.replace(/[k–∫]/g, ''); }
        return (parseFloat(s) || 0) * m;
    }

    function getItems(id) {
        const rows = document.querySelectorAll(`#${id} .item-row`);
        return Array.from(rows).map(r => ({
            day: parseInt(r.querySelector('.d').value),
            amount: parseVal(r.querySelector('.v').value)
        })).filter(i => i.day && i.amount);
    }

    // –õ–û–ì–ò–ö–ê –°–ò–ú–£–õ–Ø–¶–ò–ò (–ö–ê–ö –í –ë–û–¢–ï)
    function simulate(limit, data) {
        let bal = data.balance;
        const start = data.currentDay;
        const end = data.daysTotal;
        const timeline = {};

        data.all_inc.forEach(i => { if(i.day >= start) { timeline[i.day] = (timeline[i.day]||0) + i.amount; }});
        data.all_exp.forEach(i => { if(i.day >= start) { timeline[i.day] = (timeline[i.day]||0) - i.amount; }});

        for(let d = start; d <= end; d++) {
            bal += (timeline[d] || 0);
            bal -= (data.ironDaily + limit);
            if(d === end) bal -= data.savings;
            if(bal < -100) return false;
        }
        return true;
    }

    function finish() {
        const data = {
            month: document.getElementById('monthName').value,
            daysTotal: parseInt(document.getElementById('daysTotal').value),
            currentDay: parseInt(document.getElementById('currentDay').value),
            balance: parseVal(document.getElementById('balance').value),
            ironDaily: parseVal(document.getElementById('ironDaily').value),
            savings: parseVal(document.getElementById('savings').value),
            all_inc: getItems('incomes-list'),
            all_exp: [...getItems('loans-list'), ...getItems('utils-list'), ...getItems('shop-list')],
            sums: {
                loans: getItems('loans-list').reduce((a,b)=>a+b.amount,0),
                utils: getItems('utils-list').reduce((a,b)=>a+b.amount,0),
                shop: getItems('shop-list').reduce((a,b)=>a+b.amount,0)
            }
        };

        const daysLeft = data.daysTotal - data.currentDay + 1;
        const totalInc = data.balance + data.all_inc.reduce((a,b)=>a+b.amount,0);
        const totalExp = data.all_exp.reduce((a,b)=>a+b.amount,0) + data.savings;
        const ironNeeded = data.ironDaily * daysLeft;
        const freePool = totalInc - totalExp - ironNeeded;

        let safeLimit = 0;
        let cashGap = false;

        if(freePool > 0) {
            let low = 0, high = (freePool / daysLeft) * 1.2;
            for(let i=0; i<20; i++) {
                let mid = (low + high) / 2;
                if(simulate(mid, data)) { safeLimit = mid; low = mid; } 
                else { high = mid; }
            }
            if(safeLimit < (freePool/daysLeft)*0.9) cashGap = true;
        } else {
            safeLimit = -1;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
        const result = {
            ...data,
            safeLimit,
            cashGap,
            daysLeft,
            totalInc,
            totalExp,
            ironNeeded
        };
        tg.sendData(JSON.stringify(result));
    }
</script>
</body>
</html>
